from flask import Flask, request, render_template, redirectimport MySQLdb as mysqlapp = Flask(__name__)@app.route('/', methods=["POST", "GET"])def user_login():	return user_check()@app.route('/add', methods=["POST", "GET"])def user_sign():	return user_add()@app.route('/home', methods=["POST", "GET"])def home():	user = request.args.get('username')	return render_template('user.html', user=user)@app.route('/users', methods=["POST", "GET"])def user_list():	users = load_user_from_db()	return render_template('user_list.html', users=users)@app.route('/delete', methods=['GET'])def delete():	id = request.args.get('id', None)	if not id:		error = "could not found user "		return render_template("user_list.html", error=error)	try:		conn = mysql.connect(user='root', host='127.0.0.1', passwd='1q2w3e4r', db='reboot10', charset='utf8')		cur = conn.cursor()		sql = "select name from users where id = %s" % id		cur.execute(sql)		conn.commit		cur.close		conn.close		return 'deleted'	# return redirect('/users')	except:		error = "delete failed"		return render_template("user_list.html", error=error)@app.route('/update', methods=['GET', 'POST'])def update():	if request.method == "POST":		print request.form		data = dict(request.form)		conn = mysql.connect(user='root', host='127.0.0.1', passwd='1q2w3e4r', db='reboot10', charset='utf8')		cur = conn.cursor()		conditions = ["%s='%s'" % (k, v[0]) for k, v in data.items()]		sql = "update users set %s where id = %s" % (','.join(conditions), data['id'][0])		cur.execute(sql)		return redirect('/users')	else:		id = request.args.get('id', None)		if not id:			errmsg = "must have id"			return render_template("update.html", result=errmsg)		fields = ['id', 'name', 'name_cn', 'email', 'mobile']		try:			conn = mysql.connect(user='root', host='127.0.0.1', passwd='1q2w3e4r', db='reboot10', charset='utf8')			cur = conn.cursor()			sql = "select %s from users where id = %s " % (','.join(fields), id)			cur.execute(sql)			res = cur.fetchone()			user = {}			for i, k in enumerate(fields):				user[k] = res[i]			return render_template('update.html', user=user)		except:			errmsg = "get one failed"			print traceback.print_exc()			return render_template("update.html", result=errmsg)def load_user_from_db():	users = []	conn = mysql.connect(user='root', host='127.0.0.1', passwd='1q2w3e4r', db='reboot10', charset='utf8')	cur = conn.cursor()	fielded = ['id', 'name', 'name_cn', 'password', 'email', 'mobile']	sql = "select %s from users" % ','.join(fielded)	cur.execute(sql)	result = cur.fetchall()	cur.close	for row in result:		user = {}		for i, k in enumerate(fielded):			user[k] = row[i]		users.append(user)	return usersdef user_check():	error = None	message = 'User login successful'	if request.method == 'POST':		username = request.form['username']		password = request.form['password']		if not username or not password:			error = 'username and password is null!!!!'			return render_template('login.html', error=error)		try:			conn = mysql.connect(user='root', host='127.0.0.1', passwd='1q2w3e4r', db='reboot10', charset='utf8')			cur = conn.cursor()			sql_username = "select 1 from users where name ='%s'" % username			result = cur.execute(sql_username)			if result:				field = 'password'				sql_password = "select %s from users where name ='%s'" % (field, username)				cur.execute(sql_password)				password_stored = cur.fetchone()[0]				if password == password_stored:					if username == 'admin':						return redirect('/users')					else:						# return redirect('/home')						return render_template('user.html', username=username)				else:					error = 'invalid username or password'					return render_template('login.html', error=error)			cur.close()			conn.close()		except(mysql.MySQLError, Exception):			error = 'db error'			return render_template('login.html', error=error)	return render_template('login.html', error=error)def user_add():	error = None	message = 'register successful'	if request.method == 'POST':		user_sign_name = request.form['username']		user_sign_cnname = request.form['cnname']		user_sign_password = request.form['password']		user_sign_password2 = request.form['password1']		user_sign_email = request.form['email']		user_sign_mobile = request.form['mobile']		if not user_sign_name or not user_sign_password or not user_sign_password2 or not user_sign_cnname or not user_sign_mobile or not user_sign_email:			error = 'user name and password is null!!!'			render_template('user_add.html', error=error)		try:			conn = mysql.connect(user='root', host='127.0.0.1', passwd='1q2w3e4r', db='reboot10', charset='utf8')			cur = conn.cursor()			fields = user_sign_name			sql = "select 1 from users where name = '%s'" % fields			cur.execute(sql)			result = cur.fetchone()[0]			if result:				error = 'user name already exits'			return render_template('user_add.html', error=error)			cur.close()			conn.close()		except(mysql.MySQLError, Exception):			pass		if user_sign_password != user_sign_password2:			error = ' passwords are not matched'			return render_template('user_add.html', error=error)		try:			conn = mysql.connect(user='root', host='127.0.0.1', passwd='1q2w3e4r', db='reboot10', charset='utf8')			cur = conn.cursor()			fields = ['name', 'name_cn', 'password', 'email', 'mobile']			user_info = [user_sign_name, user_sign_cnname, user_sign_password, user_sign_email, user_sign_mobile]			add_user_sql = 'insert into users (%s) values (%s);' % (','.join(fields), ','.join(['%s'] * len(user_info)))			message = 'Register successful'			cur.execute(add_user_sql, user_info)			conn.commit()			cur.close()			conn.close()			return render_template('user_add.html', message=message)		except(mysql.MySQLError, Exception):			error = 'db error'			return render_template('user_add.html', error=error)	return render_template('user_add.html', error=error)if __name__ == '__main__':	app.run(host='0.0.0.0', port=8080, debug=True)